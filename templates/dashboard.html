<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UrbanSphere Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-8">
    <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-md mb-8">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center">
            <svg class="w-8 h-8 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
            UrbanSphere Dashboard
        </h1>
        <div class="flex items-center text-sm">
            <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
            <span class="text-gray-600 font-medium">Current Status: Operational</span>
        </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- Agent Status Column -->
        <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Agent Status</h2>
            <div id="agent-status-container" class="space-y-4">
                <!-- Agent status will be dynamically inserted here -->
            </div>
        </div>

        <!-- Recent Conversations Column -->
        <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Recent Conversations</h2>
            <div id="conversations-container" class="space-y-4">
                <!-- Conversation data will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- The JavaScript to make the dashboard dynamic -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Function to fetch data from the API and update the dashboard
            function updateDashboard() {
                fetch('/api/data')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Update Agent Status
                        const agentStatusContainer = document.getElementById('agent-status-container');
                        agentStatusContainer.innerHTML = ''; // Clear previous content
                        data.agent_status.forEach(agent => {
                            const statusColor = agent.status === 'Online' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                            const statusIcon = agent.status === 'Online' ? 'fas fa-check-circle' : 'fas fa-times-circle';
                            const agentHtml = `
                                <div class="flex items-center justify-between p-4 ${statusColor} rounded-lg">
                                    <span class="font-medium">${agent.name}</span>
                                    <span class="font-medium">${agent.status} <i class="${statusIcon} ml-2"></i></span>
                                </div>
                            `;
                            agentStatusContainer.innerHTML += agentHtml;
                        });

                        // Update Conversations
                        const conversationsContainer = document.getElementById('conversations-container');
                        conversationsContainer.innerHTML = ''; // Clear previous content

                        // Create a map to group messages by sender_id
                        const conversationsMap = {};
                        data.conversations.forEach(msg => {
                            if (!conversationsMap[msg.sender_id]) {
                                conversationsMap[msg.sender_id] = [];
                            }
                            conversationsMap[msg.sender_id].push(msg);
                        });

                        for (const senderId in conversationsMap) {
                            const conversation = conversationsMap[senderId];
                            let conversationHtml = `<div class="bg-blue-50 p-4 rounded-lg shadow-sm">
                                <h3 class="font-bold text-gray-700 mb-2">Conversation with: ${senderId}</h3>
                            `;

                            conversation.forEach(msg => {
                                conversationHtml += `
                                    <div class="p-2 my-2 rounded-md ${msg.user ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                                        <p class="font-semibold">${msg.user ? 'User' : 'Brenda'}:</p>
                                        <p>${msg.user ? msg.user : msg.agent}</p>
                                    </div>
                                `;
                            });
                            conversationHtml += '</div>';
                            conversationsContainer.innerHTML += conversationHtml;
                        }
                    })
                    .catch(error => console.error('Error fetching dashboard data:', error));
            }

            // Call the function once on page load to display initial data
            updateDashboard();

            // Set up a timer to update the dashboard every 5 seconds
            setInterval(updateDashboard, 5000);
        });
    </script>
</body>
</html>
