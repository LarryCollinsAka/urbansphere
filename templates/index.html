<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civic Participation Hub</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f0f4f8;
            color: #334155;
        }
        /* Custom scrollbar for the chat */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            border-radius: 4px;
            border: 2px solid #f0f4f8;
        }
        .typing-indicator span {
            animation: blink 1s infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes blink {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Main Container -->
    <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-8 w-full max-w-6xl flex flex-col md:flex-row h-[90vh]">

        <!-- Left Panel: Chat Interface -->
        <div class="flex-1 flex flex-col bg-gray-50 rounded-2xl p-4 md:p-6 mb-6 md:mb-0 md:mr-6 shadow-inner">
            <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Chat with Brenda</h1>
            
            <!-- Chat Log -->
            <div id="chat-log" class="flex-1 overflow-y-auto space-y-4 p-4 chat-container rounded-lg bg-white shadow-md">
                <!-- Initial welcome message from Brenda -->
                <div class="flex justify-start">
                    <div class="bg-indigo-200 text-indigo-900 rounded-2xl rounded-bl-none p-4 max-w-[80%] shadow-md">
                        <p>Hello! I'm Brenda, your AI assistant for Urban Sustainability. How can I help you today?</p>
                    </div>
                </div>
            </div>

            <!-- Input Form -->
            <form id="chat-form" class="mt-4 flex items-center">
                <input type="text" id="user-input" placeholder="Ask a question..." class="flex-1 p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200" required>
                <button type="submit" class="ml-3 bg-indigo-600 text-white rounded-full p-3 hover:bg-indigo-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" />
                    </svg>
                </button>
            </form>
        </div>

        <!-- Right Panel: Dashboard -->
        <div class="flex-1 flex flex-col bg-white rounded-2xl p-4 md:p-6 shadow-inner overflow-y-auto">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Civic Participation Dashboard</h2>
            
            <div id="dashboard-content" class="space-y-6">
                
                <!-- Section 1: Urban Best Practices -->
                <div class="bg-indigo-50 rounded-xl p-4 shadow-sm">
                    <h3 class="text-lg font-semibold text-indigo-700 mb-2">Urban Best Practices</h3>
                    <ul id="best-practices-list" class="list-disc pl-5 text-gray-700 space-y-1"></ul>
                </div>

                <!-- Section 2: Air Quality Actions -->
                <div class="bg-indigo-50 rounded-xl p-4 shadow-sm">
                    <h3 class="text-lg font-semibold text-indigo-700 mb-2">Air Quality Actions</h3>
                    <ul id="air-quality-list" class="list-disc pl-5 text-gray-700 space-y-1"></ul>
                </div>
                
                <!-- Section 3: Housing Upgrade Tips -->
                <div class="bg-indigo-50 rounded-xl p-4 shadow-sm">
                    <h3 class="text-lg font-semibold text-indigo-700 mb-2">Housing Upgrade Tips</h3>
                    <ul id="housing-tips-list" class="list-disc pl-5 text-gray-700 space-y-1"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use a self-invoking async function for better scope management
        (async function() {
            // --- DATA LOADING & API SETUP ---
            // This data mimics the knowledge_base.json file
            const knowledgeBase = {
                "urban_best_practices": [
                    "Increase green spaces to improve air quality and mental health.",
                    "Implement affordable housing programs with community input.",
                    "Promote mixed-use development for walkable neighborhoods.",
                    "Upgrade sanitation infrastructure in underserved areas.",
                    "Use sensors and open data for real-time urban monitoring."
                ],
                "air_quality_actions": [
                    "Promote public transport and cycling to reduce vehicle emissions.",
                    "Plant trees and create urban parks to absorb pollutants.",
                    "Ban open burning of waste in residential areas.",
                    "Encourage clean energy adoption for homes and businesses."
                ],
                "housing_upgrade_tips": [
                    "Retrofit buildings for energy efficiency.",
                    "Use locally sourced and sustainable materials.",
                    "Design homes with adequate ventilation.",
                    "Include rainwater harvesting systems in new developments."
                ]
            };
            
            const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";
            const API_KEY = ""; // Canvas will provide this at runtime.

            // --- DASHBOARD RENDERING ---
            function renderDashboard() {
                // Render Urban Best Practices
                const bestPracticesList = document.getElementById('best-practices-list');
                knowledgeBase.urban_best_practices.forEach(practice => {
                    const li = document.createElement('li');
                    li.textContent = practice;
                    bestPracticesList.appendChild(li);
                });

                // Render Air Quality Actions
                const airQualityList = document.getElementById('air-quality-list');
                knowledgeBase.air_quality_actions.forEach(action => {
                    const li = document.createElement('li');
                    li.textContent = action;
                    airQualityList.appendChild(li);
                });

                // Render Housing Upgrade Tips
                const housingTipsList = document.getElementById('housing-tips-list');
                knowledgeBase.housing_upgrade_tips.forEach(tip => {
                    const li = document.createElement('li');
                    li.textContent = tip;
                    housingTipsList.appendChild(li);
                });
            }

            renderDashboard();

            // --- CHAT FUNCTIONALITY ---
            const chatForm = document.getElementById('chat-form');
            const chatLog = document.getElementById('chat-log');
            const userInput = document.getElementById('user-input');
            const initialPrompt = "Your name is Brenda. You are an AI assistant for an Urban SDG platform. Your role is to help city residents and officials by answering questions about urban sustainability, air quality, housing upgrades, and civic feedback. Provide clear, actionable, and context-aware responses. If asked for suggestions or feedback, base them on sustainable development goals and best practices in urban planning. Always introduce yourself as Brenda when appropriate, and respond in a friendly, helpful tone.";

            const chatHistory = [{
                role: "system",
                parts: [{ text: initialPrompt }]
            }];

            // Function to add a message to the chat log
            function addMessage(text, isUser) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('flex', isUser ? 'justify-end' : 'justify-start');
                
                const bubble = document.createElement('div');
                bubble.classList.add(
                    'rounded-2xl',
                    'p-4',
                    'max-w-[80%]',
                    'shadow-md',
                    'transition-all',
                    'duration-300',
                    'ease-in-out'
                );
                
                if (isUser) {
                    bubble.classList.add('bg-indigo-600', 'text-white', 'rounded-br-none');
                } else {
                    bubble.classList.add('bg-indigo-200', 'text-indigo-900', 'rounded-bl-none');
                }
                
                bubble.textContent = text;
                messageDiv.appendChild(bubble);
                chatLog.appendChild(messageDiv);
                
                // Scroll to the bottom of the chat log
                chatLog.scrollTop = chatLog.scrollHeight;
            }

            // Function to handle API calls with exponential backoff
            async function fetchWithBackoff(url, options, retries = 5, delay = 1000) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) { // Too many requests
                        if (retries > 0) {
                            console.warn(`Rate limit exceeded, retrying in ${delay}ms...`);
                            await new Promise(res => setTimeout(res, delay));
                            return fetchWithBackoff(url, options, retries - 1, delay * 2);
                        } else {
                            throw new Error("Maximum retries exceeded. Rate limit error.");
                        }
                    } else if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    if (retries > 0) {
                        console.warn(`Fetch failed, retrying in ${delay}ms...`);
                        await new Promise(res => setTimeout(res, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    } else {
                        throw error;
                    }
                }
            }

            // Function to get a response from the Gemini API
            async function getGeminiResponse(userPrompt) {
                chatHistory.push({ role: "user", parts: [{ text: userPrompt }] });

                const payload = {
                    "contents": chatHistory
                };

                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };

                const fullUrl = `${API_URL}${API_KEY}`;
                
                try {
                    const response = await fetchWithBackoff(fullUrl, options);
                    
                    const text = response?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        chatHistory.push({ role: "model", parts: [{ text: text }] });
                        return text;
                    } else {
                        console.error("API response lacked expected text content:", response);
                        return "Sorry, I couldn't get a response. Please try again.";
                    }
                } catch (error) {
                    console.error("Failed to fetch response from API:", error);
                    return "There was an error connecting to the service. Please try again later.";
                }
            }
            
            // Event listener for form submission
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userMessage = userInput.value.trim();
                
                if (userMessage) {
                    addMessage(userMessage, true);
                    userInput.value = '';
                    
                    // Show a typing indicator
                    const typingIndicator = document.createElement('div');
                    typingIndicator.classList.add('flex', 'justify-start', 'typing-indicator');
                    typingIndicator.innerHTML = `
                        <div class="bg-gray-300 text-gray-700 rounded-2xl rounded-bl-none p-4 max-w-[80%] shadow-md">
                            <span>.</span><span>.</span><span>.</span>
                        </div>
                    `;
                    chatLog.appendChild(typingIndicator);
                    chatLog.scrollTop = chatLog.scrollHeight;

                    // Get response from the model
                    const response = await getGeminiResponse(userMessage);
                    
                    // Remove typing indicator and add Brenda's message
                    chatLog.removeChild(typingIndicator);
                    addMessage(response, false);
                }
            });
        })();